# DDH私密交集求和协议实现

## 实现思路

这个协议基于DDH(Decisional Diffie-Hellman)假设和Paillier同态加密，允许两方在不泄露各自私有数据的情况下，计算他们集合交集中元素对应值的总和。

### 主要数学原理

1. **DDH假设**：在循环群G中，给定$(g, g^a, g^b, g^c)$，难以区分$g^c$和$g^(ab)$。这里使用乘法群模素数p，生成元为g
2. **哈希函数**：将元素映射到群G中，建模为随机预言机
3. **Paillier加密**：加法同态性质：$E(a) ⊗ E(b) = E(a + b)$允许对加密值进行加法运算而不需解密



### **DDHPrivateIntersectionSum 协议的原理**

该协议的核心思想基于 **Diffie-Hellman 密钥交换（DDH）** 和 **Paillier 同态加密**，实现了 **私有集合交集求和（PSI-CA, Private Set Intersection with Cardinality and Attribute summation）**。我们可以大致分为以下几个部分：

---

### **1. Diffie-Hellman 密钥交换（DDH 假设）**
协议的核心依赖于 **离散对数问题（DLP）** 和 **Decisional Diffie-Hellman（DDH）假设**：

设  G  是一个乘法循环群， p是一个大素数， g 是 G 的生成元。**DDH 假设** 认为，给定 $ (g, g^a, g^b, g^c) $，无法高效区分 $ g^c $和 $g^{ab} $，除非知道 $ a $ 或 $ b $（即计算离散对数）。

在协议中：
- **P1** 计算 $ H(v)^{k_1}$ ($ g^{h(v) \cdot k_1} $) 。
- **P2** 计算 $H(v)^{k_1 k_2} $ ($ g^{h(v) \cdot k_1 k_2} $)。
- **P2** 还计算 $H(w)^{k_2} $ ($ g^{h(w) \cdot k_2} $) 。
- **P1** 最终计算 $ H(w)^{k_1 k_2} $ ($ g^{h(w) \cdot k_1 k_2} $)。

**只有当 $v = w $时，$ H(v)^{k_1 k_2} = H(w)^{k_1 k_2} $**，否则由于 DDH 假设，无法推断任何信息。



### **2. 哈希函数（随机预言机模型）**
为了将任意数据（如字符串）映射到群 \( G \)，协议使用 **密码学哈希函数**（如 SHA-256）：

给定输入 \( x \)，计算 $h = \text{SHA256}(x)$，并映射到 G ：
$$
H(x) = g^{h \mod (p-1)} \mod p
$$
由于哈希函数建模为 **随机预言机（Random Oracle）**，攻击者无法预测 \( H(x) \) 的结构。



### **3. Paillier 同态加密（加法同态）**
为了在不泄露交集元素值的情况下计算它们的和，协议使用 **Paillier 加密**：
- **密钥生成**：公钥 (n, g) ，私钥 $ \lambda $，其中$ n = pq $（两个大素数）。
- **加密**：明文  m ，随机数 r ，密文：
$$
    E(m) = g^m \cdot r^n \mod n^2
$$
- **加法同态**：给定 E(a)和 E(b) ，可以计算：
$$
E(a + b) = E(a) \cdot E(b) \mod n^2
$$
这使得 P1 可以在不知道明文的情况下计算交集元素的和。

------



### 协议实现流程

1. **初始化阶段**：

确定公共参数：素数p、生成元g、哈希函数H。根据上面给出的公式，双方各自生成私钥k₁和k₂，P2生成Paillier密钥对。

2. **第一轮(P1→P2)**：P1对每个元素v计算H(v)^k₁ mod p，打乱顺序后发送给P2

3. **第二轮(P2→P1)**：P2对收到的每个元素计算$(H(v)^k₁)^k₂ = H(v)^(k₁k₂) mod p$，对自己的每个元素w计算$H(w)^k₂ mod p$和t的Paillier加密，打乱顺序后发送给P1。

4. **第三轮(P1计算→P2)**：P1计算$(H(w)^k₂)^k₁ = H(w)^(k₁k₂) mod p$与P2发送的$H(v)^(k₁k₂)$比较找出交集对交集的加密值求和后发送给P2

5. **解密输出**：P2解密得到交集中元素值的总和

---

### **安全性分析**
1. **P1 无法知道 P2 的集合$W $**：P1 只能看到 $ H(w)^{k_2} $，由于 DDH 假设，无法计算4w 4或 $ H(w) $。
2. **P2 无法知道 P1 的集合 $ V $**：P2 只能看到 $ H(v)^{k_1}$，同样无法计算 $ v $或 $ H(v) $。
3. **求和过程保护隐私**：P1 只能对匹配项的加密值求和，无法知道具体值。P2 只能知道最终的和，而不知道哪些元素匹配。

---

因此该协议通过 **DDH 假设** 确保集合元素的隐私，并通过 **Paillier 同态加密** 实现安全的交集求和。整个过程 **不泄露交集的具体元素**，仅输出它们的和，适用于 **隐私保护的联合数据分析**。



### 结果实现

![image-20250814044415973](C:\Users\LuoJY\AppData\Roaming\Typora\typora-user-images\image-20250814044415973.png)